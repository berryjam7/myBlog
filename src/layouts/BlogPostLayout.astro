---
import type { CollectionEntry } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ReadingTime from '../components/ReadingTime.astro';
import SocialShare from '../components/SocialShare.astro';
import TableOfContents from '../components/TableOfContents.astro';
import RelatedPosts from '../components/RelatedPosts.astro';

export interface Props {
  post: CollectionEntry<'blog'>;
  headings: { depth: number; slug: string; text: string; }[];
  relatedPosts: CollectionEntry<'blog'>[];
}

const { post, headings, relatedPosts } = Astro.props;
const { title, description, pubDate, updatedDate, heroImage, category, tags, author } = post.data;

const breadcrumbs = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: Astro.site
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Blog',
      item: new URL('/blog', Astro.site)
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: title,
      item: new URL(Astro.url.pathname, Astro.site)
    }
  ]
};
---

<BaseLayout 
  title={title}
  description={description}
  image={heroImage}
  type="article"
  publishedTime={pubDate}
  modifiedTime={updatedDate}
  author={author}
  tags={tags}
>
  <div class="reading-progress"></div>
  <Header />
  
  <main class="container" style="padding-top: 2rem; padding-bottom: 3rem;">
    <article class="blog-post">
      <!-- Breadcrumbs -->
      <nav class="breadcrumbs" style="margin-bottom: 1.5rem; font-size: 0.875rem;">
        <a href="/">홈</a> / 
        <a href="/blog">블로그</a> / 
        <a href={`/categories/${category}`}>{category}</a> / 
        <span style="color: var(--text-muted);">{title}</span>
      </nav>
      
      <!-- Hero Image -->
      {heroImage && (
        <img 
          src={heroImage} 
          alt={title}
          class="hero-image"
          style="width: 100%; height: 400px; object-fit: cover; border-radius: var(--radius-lg); margin-bottom: 2rem;"
        />
      )}
      
      <!-- Post Header -->
      <header class="post-header" style="margin-bottom: 2rem;">
        <a href={`/categories/${category}`} class="badge" style="margin-bottom: 1rem;">{category}</a>
        <h1 style="margin-bottom: 0.5rem;">{title}</h1>
        <p style="color: var(--text-muted); font-size: 1.125rem; margin-bottom: 1rem;">{description}</p>
        
        <div class="post-meta" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; color: var(--text-secondary); font-size: 0.9rem;">
          <span>
            <strong>{author}</strong>
          </span>
          <span>•</span>
          <time datetime={pubDate.toISOString()}>
            {pubDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}
          </time>
          {updatedDate && (
            <>
              <span>•</span>
              <span>
                수정: {updatedDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}
              </span>
            </>
          )}
          <span>•</span>
          <ReadingTime content={post.body} />
        </div>
        
        <!-- Tags -->
        <div class="post-tags" style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
          {tags.map(tag => (
            <a href={`/tags/${tag}`} class="tag">#{tag}</a>
          ))}
        </div>
      </header>
      
      <!-- Table of Contents & Content -->
      <div class="post-content-wrapper" style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
        {headings.length > 0 && (
          <aside class="toc-sidebar" style="display: none;">
            <TableOfContents headings={headings} />
          </aside>
        )}
        
        <div class="post-content prose">
          <slot />
        </div>
      </div>
      
      <!-- Social Share -->
      <div style="margin: 3rem 0; padding: 2rem 0; border-top: 2px solid var(--border); border-bottom: 2px solid var(--border);">
        <SocialShare title={title} url={Astro.url.pathname} />
      </div>
      
      <!-- Related Posts -->
      {relatedPosts.length > 0 && (
        <div style="margin-top: 3rem;">
          <RelatedPosts posts={relatedPosts} />
        </div>
      )}
    </article>
  </main>
  
  <Footer />
  
  <button class="scroll-to-top" aria-label="Scroll to top">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
  </button>
  
  <!-- Breadcrumb Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbs)} />
</BaseLayout>

<style>
  @media (min-width: 1024px) {
    .post-content-wrapper {
      grid-template-columns: 250px 1fr !important;
    }
    
    .toc-sidebar {
      display: block !important;
      position: sticky;
      top: 2rem;
      align-self: start;
    }
  }
  
  .breadcrumbs a {
    color: var(--primary-dark);
    transition: color var(--transition-base);
  }
  
  .breadcrumbs a:hover {
    color: var(--primary);
  }
</style>
